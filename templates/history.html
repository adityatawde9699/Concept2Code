{% extends "base.html" %}

{% block title %}Booking History - ParkWise{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">Your Bookings</h1>
        <p class="page-subtitle">View your parking history</p>
    </div>

    {% if bookings %}
    <div class="bookings-list">
        {% for booking in bookings %}
        <div class="booking-card">
            <div class="booking-header">
                <div class="booking-slot">
                    <span class="slot-id">{{ booking.slot.slot_number }}</span>
                    <span class="slot-zone">Zone {{ booking.slot.zone }}</span>
                </div>
                <div class="booking-status">
                    {% if booking.status == 'active' %}
                        <span class="badge active">Active</span>
                    {% else %}
                        <span class="badge completed">Completed</span>
                    {% endif %}
                </div>
            </div>

            <div class="booking-body">
                <div class="booking-row">
                    <strong>{{ booking.user_name }}</strong>
                    {% if booking.phone_number %}
                    <span class="text-muted">{{ booking.phone_number }}</span>
                    {% endif %}
                </div>
                
                {% if booking.vehicle_type %}
                <div class="booking-row">
                    <span class="label">Vehicle</span>
                    <span>{{ booking.vehicle_type }}
                        {% if booking.vehicle_number %}
                        • {{ booking.vehicle_number }}
                        {% endif %}
                    </span>
                </div>
                {% endif %}

                <div class="booking-row">
                    <span class="label">Started</span>
                    <span>{{ booking.start_time.strftime('%d %b %Y, %H:%M') }}</span>
                </div>

                {% if booking.end_time %}
                <div class="booking-row">
                    <span class="label">Ended</span>
                    <span>{{ booking.end_time.strftime('%d %b %Y, %H:%M') }}</span>
                </div>

                <div class="booking-row">
                    <span class="label">Duration</span>
                    <span>
                        {% set mins = ((booking.end_time - booking.start_time).total_seconds() / 60) | int %}
                        {% if mins >= 60 %}
                            {{ (mins // 60) }}h {{ mins % 60 }}m
                        {% else %}
                            {{ mins }} min
                        {% endif %}
                    </span>
                </div>
                {% endif %}

                {% if booking.total_cost %}
                <div class="booking-row price-row">
                    <span class="label">Cost</span>
                    <span class="price">₹{{ "%.2f" | format(booking.total_cost) }}</span>
                </div>
                {% endif %}
            </div>

            {% if booking.status == 'active' %}
            <div class="booking-footer">
                <button type="button" class="btn btn-secondary" onclick="endBooking({{ booking.id }})">
                    Check Out
                </button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <h2>No Bookings Yet</h2>
        <p>You haven't made any parking reservations</p>
        <a href="/find-parking" class="btn btn-primary">Find Parking Now</a>
    </div>
    {% endif %}
</div>

<script>
function endBooking(bookingId) {
    if (confirm('Check out this booking?')) {
        fetch(`/end-booking/${bookingId}`, { method: 'POST' })
            .then(r => r.json())
            .then(d => { alert('Checked out. Cost: ₹' + d.total_cost); location.reload(); });
    }
}
</script>
{% endblock %}
